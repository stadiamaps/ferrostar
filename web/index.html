<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ferrostar Web Demo</title>
    <link rel="stylesheet" href="./src/index.css" />
    <link
      href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <link
      href="https://unpkg.com/@stadiamaps/maplibre-search-box/dist/maplibre-search-box.css"
      rel="stylesheet"
    />

    <style>
      .map-container {
        position: relative;
        height: 100%;
        width: 100%;
      }

      .map-element {
        height: 100%;
        width: 100%;
      }

      #ferrostar {
        position: absolute;
      }
    </style>
  </head>
  <body>
    <p>
      Search and select a destination, or
      <button id="simulate">Simulate Navigation</button> or
      <button id="replay">Replay Navigation</button>
      <input type="file" id="replayFile" style="display: none" />
    </p>

    <p style="margin-top: 0">
      <input type="checkbox" id="voiceGuidance" />
      <label for="voiceGuidance">Enable voice guidance (sound on)</label>
      <input type="checkbox" id="shouldRecord" />
      <label for="shouldRecord">Record</label>
    </p>

    <!--
This should not require any API key if run via `npm run dev`.
Learn how to get a free prod API key here: https://docs.stadiamaps.com/authentication/.
See https://stadiamaps.github.io/ferrostar/vendors.html for more info on basemap vendors.
-->
    <div class="map-container">
      <ferrostar-map id="ferrostar"></ferrostar-map>
      <div class="map-element" id="mapElement"></div>
    </div>

    <script type="module">
      import {
        FerrostarMap,
        FerrostarCore,
        SimulatedLocationProvider,
        BrowserLocationProvider,
      } from "@stadiamaps/ferrostar-webcomponents";
      import mapLibreGL from "maplibre-gl";
      import { MapLibreSearchControl } from "@stadiamaps/maplibre-search-box";
      import { ReplayController } from "./src/replay-controller.js";

      // TODO: type + use TypeScript enum
      const config = {
        stepAdvanceCondition: {
          DistanceEntryExit: {
            minimumHorizontalAccuracy: 25,
            distanceToEndOfStep: 30,
            distanceAfterEndStep: 5,
            hasReachedEndOfCurrentStep: false,
          },
        },
        arrivalStepAdvanceCondition: {
          DistanceToEndOfStep: {
            distance: 30,
            minimumHorizontalAccuracy: 25,
          },
        },
        routeDeviationTracking: {
          StaticThreshold: {
            minimumHorizontalAccuracy: 25,
            maxAcceptableDeviation: 10.0,
          },
        },
        snappedLocationCourseFiltering: "Raw",
        waypointAdvance: {
          WaypointWithinRange: 100,
        },
      };

      async function onload() {
        // Set up and customize your map instance as desired
        const mapInstance = new mapLibreGL.Map({
          container: "mapElement",
          style: "https://tiles.stadiamaps.com/styles/outdoors.json",
          center: { lng: -122.42, lat: 37.81 },
          zoom: 16,
          pitch: 45,
          attributionControl: { compact: true },
        });

        // Get a reference to the Ferrostar map component
        const ferrostarMap = document.getElementById("ferrostar");
        let ferrostarCore = new FerrostarCore();
        ferrostarCore.valhallaEndpointUrl =
          "https://api.stadiamaps.com/route/v1";
        ferrostarCore.profile = "bicycle";

        ferrostarMap.map = mapInstance;
        ferrostarMap.system = "imperial";
        ferrostarMap.maxDecimalPlaces = 2;

        // Create a search control.
        const searchBox = new MapLibreSearchControl({
          onResultSelected: async (feature) => {
            const coordinates = feature.geometry.coordinates;
            const waypoints = [
              {
                coordinate: { lat: coordinates[1], lng: coordinates[0] },
                kind: "Break",
              },
            ];

            // FIXME: This is a hack basically to support the demo page that should go away.
            if (
              !ferrostarCore.locationProvider ||
              ferrostarCore.locationProvider instanceof
                SimulatedLocationProvider
            ) {
              ferrostarCore.locationProvider = new BrowserLocationProvider();
            }

            // Fetch the user's current location.
            // If we have a cached one that's no older than 30 seconds,
            // skip waiting for an update and use the slightly stale location.
            const location =
              await ferrostarCore.locationProvider.getCurrentLocation(30_000);

            // Use the acquired user location to request the route
            const routes = await ferrostarCore.getRoutes(location, waypoints);
            const route = routes[0];
            ferrostarMap.route = route;
            ferrostarMap.linkWith(ferrostarCore);

            // Start the navigation
            ferrostarCore.startNavigation(route, config);
          },
        });

        ferrostarCore.options = {
          costing_options: { bicycle: { use_roads: 0.2 } },
        };
        ferrostarMap.geolocateOnLoad = false;

        const shouldRecordCheckbox = document.getElementById("shouldRecord");

        mapInstance.on("load", (_) => {
          // Post-first-load configuration
          mapInstance.addControl(searchBox, "top-left");
        });
        ferrostarCore.onNavigationStart = () => {
          // Remove our search box when navigation starts
          mapInstance.removeControl(searchBox);
          // Prevent user from changing shouldRecord during navigation
          shouldRecordCheckbox.disabled = true;
        };
        ferrostarCore.onNavigationStop = () => {
          // Put the search box back when we stop
          mapInstance.addControl(searchBox, "top-left");
          shouldRecordCheckbox.disabled = false;
        };

        const simulateNavigationButton = document.getElementById("simulate");

        shouldRecordCheckbox.addEventListener("change", (event) => {
          ferrostarCore.shouldRecord = event.target.checked;
        });

        // Button to start simulated navigation
        simulateNavigationButton.addEventListener("click", async () => {
          // Simulated location
          const initialSimulatedLocation = {
            coordinates: { lat: 37.807770999999995, lng: -122.41970699999999 },
            horizontalAccuracy: 6.0,
            courseOverGround: null,
            timestamp: Date.now(),
            speed: null,
          };

          const simulatedWaypoints = [
            { coordinate: { lat: 37.807587, lng: -122.428411 }, kind: "Break" },
          ];

          // Request the route
          const routes = await ferrostarCore.getRoutes(
            initialSimulatedLocation,
            simulatedWaypoints,
          );
          const route = routes[0];
          ferrostarMap.route = route;

          // Set the simulated location provider
          const locationProvider = new SimulatedLocationProvider();
          locationProvider.lastLocation = initialSimulatedLocation;
          locationProvider.warpFactor = 2;
          locationProvider.setSimulatedRoute(route);

          // Start the navigation
          ferrostarMap.linkWith(ferrostarCore, true);
          ferrostarCore.locationProvider = locationProvider;
          ferrostarCore.startNavigation(route, config);
        });

        const replayButton = document.getElementById("replay");
        const replayFile = document.getElementById("replayFile");

        replayButton.addEventListener("click", () => {
          replayFile.click();
        });

        replayFile.addEventListener("change", async () => {
          const file = replayFile.files?.[0];

          if (!file) return;

          const json = await file.text();
          let replay = new ReplayController(json);
          ferrostarMap.linkWith(replay, true);

          replay.onNavigationStart = () => {
            // Remove our search box when navigation starts
            mapInstance.removeControl(searchBox);
            // Prevent user from changing shouldRecord during navigation
            shouldRecordCheckbox.disabled = true;
            // Disable the replay button while replaying
            replayButton.disabled = true;
          };

          replay.onNavigationStop = () => {
            // Put the search box back when we stop
            mapInstance.addControl(searchBox, "top-left");
            shouldRecordCheckbox.disabled = false;
            replayButton.disabled = false;
          };

          await replay.startReplay();
        });

        const voiceGuidanceCheckbox = document.getElementById("voiceGuidance");
        voiceGuidanceCheckbox.addEventListener("change", (event) => {
          ferrostarCore.useVoiceGuidance = event.target.checked;
        });
      }

      // Initialize Ferrostar and the control buttons
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", onload);
      } else {
        onload();
      }
    </script>
  </body>
</html>
